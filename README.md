# Film Platform API

**RESTful API сервис для оценки и рекомендации фильмов**

Backend-сервис, аналог Кинопоиск или IMDb, позволяющий пользователям находить фильмы, ставить им оценки (лайки), добавлять друзей и получать персональные рекомендации на основе общих вкусов. Реализован на Spring Boot с использованием чистой JDBC для полного контроля над SQL-запросами и понимания основ взаимодействия с реляционными базами данных.

## Технологии и инструменты

*   **Язык:** Java 21
*   **Фреймворк:** Spring Boot 3.2.4 (Web, Validation, JDBC, Test)
*   **База данных:** H2 (in-memory для разработки и тестирования)
*   **Библиотеки:** Project Lombok, JUnit 5, Mockito
*   **Логирование:** Logbook (для HTTP-трафика), SLF4J (для бизнес-логики)
*   **Система сборки:** Maven
*   **Документация API:** (Готов к интеграции Swagger/OpenAPI)

## Функциональность

Сервис предоставляет полноценный REST API для работы с киноплатформой:

*   **Управление пользователями:**
    *    Полный CRUD для пользователей.
    *    Добавление в друзья с двусторонним подтверждением (статусы `UNCONFIRMED`/`CONFIRMED`).
    *    Удаление из друзей с автоматическим обновлением статуса.
    *    Получение списка всех друзей пользователя.
    *    Поиск общих друзей между двумя пользователями.
    *    Лента событий - отслеживание активности друзей (лайки, отзывы, дружба).
    *    Система рекомендаций - персональные рекомендации фильмов на основе коллаборативной фильтрации.
    *    Удаление пользователей с каскадным удалением всех зависимых данных.
*   **Управление фильмами:**
    *    Полный CRUD для фильмов.
    *    Проставление и удаление лайков.
    *    Получение топа самых популярных фильмов по количеству лайков (с возможностью ограничения вывода).
    *    Расширенные фильтры для популярных фильмов (по жанру и году).
    *    Поиск фильмов по названию и режиссеру.
    *    Получение общих фильмов с другом.
    *    Получение фильмов режиссера с сортировкой по лайкам или году.
    *    Удаление фильмов с каскадным удалением всех зависимых данных.
*   **Управление отзывами:**
    *    Полный CRUD для отзывов.
    *    Оценка отзывов (лайк/дизлайк) и расчет рейтинга полезности.
    *    Получение отзывов по конкретному фильму с пагинацией.
    *    Удаление оценок отзывов.
*   **Управление справочной информацией (MPA и жанры):**
    *    Получение списка всех рейтингов MPA (G, PG, PG-13, R, NC-17) и получение по ID.
    *    Получение списка всех жанров фильмов и получение по ID.
*   **Качество кода и надежность:**
    *    Комплексная валидация входящих данных на уровне контроллеров (`@Valid`) и бизнес-логики.
    *    Централизованная обработка исключений с помощью `@ControllerAdvice`.
    *    Покрытие unit-тестами слоя хранилища (`Data Access Layer`) с использованием `@JdbcTest`.
    *    Детальное логирование всех операций.
    *    Кастомная абстракция для работы с JDBC, устраняющая дублирование кода.

## Архитектура и ключевые решения

Проект реализован по классической **трехслойной архитектуре** с четким разделением ответственности:

1.  **Controller Layer (`controller/`):** REST-контроллеры, обрабатывающие HTTP-запросы. Отвечают за валидацию входных данных, маппинг и возврат ответов.
2.  **Service Layer (`service/`):** Содержит всю бизнес-логику. Обрабатывает комплексные сценарии (например, подтверждение дружбы), проверяет права доступа и делегирует операции хранилищу.
3.  **Storage/Repository Layer (`dal/`):** Отвечает исключительно за взаимодействие с базой данных. Реализован через **"Шаблонный метод"** с использованием абстрактного класса `BaseDbStorage`, что устраняет дублирование кода и обеспечивает единообразие всех операций CRUD.

**Что выделяет этот проект:**

*   **Работа с JDBC:** Вместо простого `JdbcTemplate` реализована абстракция `BaseDbStorage`, инкапсулирующая общие операции (`findOne`, `findMany`, `insert`, `update`), что значительно уменьшает количество шаблонного кода в конечных хранилищах.
*   **Обработка ошибок:** Единый обработчик (`ErrorHandler`) возвращает структурированные и понятные сообщения об ошибках для клиента (404, 500, 400).
*   **Использование Lombok:** Для уменьшения шаблонного кода (геттеры, сеттеры, конструкторы, логирование).
*   **Тщательное логирование:** Логируются как HTTP-запросы/ответы (через Logbook), так и ключевые действия бизнес-логики.

## Командная разработка

Проект разрабатывался в команде из 3 человек. Я выполнял роль тимлида, отвечая за архитектуру, распределение задач и код-ревью.

**Мой вклад:**

*   **Архитектура и основа проекта:**
    *    Разработал базовую структуру проекта и трехслойную архитектуру.
    *    Реализовал систему пользователей с CRUD-операциями.
    *    Создал механизм дружбы с двусторонним подтверждением.
    *    Реализовал систему лайков для фильмов.
    *    Разработал кастомную JDBC-абстракцию (`BaseDbStorage`).
    *    Настроил централизованную обработку ошибок и логирование.
*   **Дополнительный функционал:**
    *    Общие фильмы - получение списка фильмов, понравившихся обоим пользователям.
    *    Режиссеры - полный CRUD для режиссеров и привязка к фильмам.
    *    Поиск фильмов - по названию и режиссеру.
    *    Удаление пользователей и фильмов - каскадное удаление со всеми зависимостями.
    *    Интеграция и код-ревью - проверка и слияние pull request'ов команды.

*   **Команда реализовала:**
    *    Систему рекомендаций фильмов
    *    Ленту событий пользователя.
    *    Систему отзывов с рейтингом полезности.
    *    Расширенные фильтры для популярных фильмов (по жанру/году).


## Схема базы данных
![ER Diagram](docs/images/schema.png)


# Запуск проекта

## Предварительные требования
- Установленный **JDK 21**
- Установленный **Maven 3.8+**

---

## 1. Клонирование и сборка
```bash
git clone https://github.com/ucheniks/film-platform-api.git
cd java-filmorate
mvn clean package
```

## 2. Запуск приложения
```bash
java -jar target/filmorate-0.0.1-SNAPSHOT.jar
```
Сервис будет доступен по адресу: [http://localhost:8080](http://localhost:8080)

> **Важно:** Приложение использует встроенную H2 базу данных в режиме файла (`./db/filmorate.mv.db`).  
> Данные сохраняются между перезапусками. База автоматически инициализируется скриптами `schema.sql` (создание таблиц) и `data.sql` (наполнение справочников) при первом запуске.

---

## 📡 API Reference

### Пользователи (`/users`)
| Метод  | Эндпоинт                          | Описание                           |
|--------|-----------------------------------|------------------------------------|
| GET    | /users                            | Получить всех пользователей        |
| GET    | /users/{id}                       | Получить пользователя по ID        |
| POST   | /users                            | Создать нового пользователя        |
| PUT    | /users                            | Обновить данные пользователя       |
| DELETE | /users/{id}                       | Удалить пользователя               |
| PUT    | /{id}/friends/{friendId}          | Добавить друга                     |
| DELETE | /{id}/friends/{friendId}          | Удалить друга                      |
| GET    | /{id}/friends                     | Список друзей пользователя         |
| GET    | /{id}/friends/common/{otherId}    | Список общих друзей                |
| GET    | /{id}/feed                        | Лента событий пользователя         |
| GET    | /{id}/recommendations             | Персональные рекомендации фильмов  |


### Фильмы (`/films`)
| Метод  | Эндпоинт                                          | Описание                                    |
|--------|---------------------------------------------------|---------------------------------------------|
| GET    | /films                                            | Получить все фильмы                         |
| GET    | /films/{id}                                       | Получить фильм по ID                        |
| POST   | /films                                            | Создать новый фильм                         |
| PUT    | /films                                            | Обновить данные фильма                      |
| DELETE | /films/{id}                                       | Удалить фильм                               |
| PUT    | /{id}/like/{userId}                               | Поставить лайк фильму                       |
| DELETE | /{id}/like/{userId}                               | Удалить лайк с фильма                       |
| GET    | /popular?count={n}&genreId={id}&year={year}       | Топ-N популярных фильмов с фильтрацией      |
| GET    | /director/{directorId}?sortBy=[likes,year]        | Фильмы режиссера с сортировкой              |
| GET    | /common?userId={id}&friendId={id}                 | Общие фильмы с другом                       |
| GET    | /search?query={text}&by=[title,director]          | Поиск фильмов                               |


### Отзывы (`/reviews`)
| Метод  | Эндпоинт                          | Описание                                |
|--------|-----------------------------------|-----------------------------------------|
| GET    | /reviews?filmId={id}&count={n}    | Получить отзывы с фильтрацией           |
| GET    | /reviews/{id}                     | Получить отзыв по ID                    |
| POST   | /reviews                          | Создать отзыв                           |
| PUT    | /reviews                          | Обновить отзыв                          |
| DELETE | /reviews/{id}                     | Удалить отзыв                           |
| PUT    | /{id}/like/{userId}               | Оценить отзыв как полезный              |
| PUT    | /{id}/dislike/{userId}            | Оценить отзыв как бесполезный           |
| DELETE | /{id}/like/{userId}               | Удалить оценку отзыва                   |



### Справочники
- Рейтинги MPA: `GET /mpa`, `GET /mpa/{id}`  
- Жанры: `GET /genres`, `GET /genres/{id}`
- Режиссёры: `GET /directors`, `GET /directors/{id}`, `POST /directors`, `PUT /directors`, `DELETE /directors/{id}`

---

## Примеры запросов

### Поиск фильмов
```bash
curl "http://localhost:8080/films/search?query=matrix&by=title,director"
```

### Общие фильмы с другом
```bash
curl "http://localhost:8080/films/common?userId=1&friendId=2"
```

### Управление режиссерами
```bash
curl -X POST -H "Content-Type: application/json" \
  -d '{"name": "Кристофер Нолан"}' \
  http://localhost:8080/directors
```

---

## Тестирование
Проект покрыт unit-тестами для слоя работы с данными (**Data Access Layer**) с использованием `@JdbcTest`, что обеспечивает изолированное тестирование с настоящей, но быстрой H2 базой данных.

### Запуск тестов
```bash
mvn test
```

---

## Скриншоты

**Пример работы с API (Postman)**  
![Создание режиссёра](docs/images/201createddirector.png)  
Создание режиссёра и успешный ответ **201 Created**.

![Добавление друга](docs/images/200ADDFRIEND.png)  
Добавление в друзья, получение списка друзей и успешный ответ **200 OK**.

**Пример обработки ошибок**  
![Ошибка запроса](docs/images/404notfound.png)  
Запрос несуществующего пользователя и четкий ответ **404 Not Found**.

## Вывод

Данный проект представляет собой **законченный бэкенд-сервис** с продуманной архитектурой и полным набором функциональности для работы с киноконтентом.  

Реализация демонстрирует понимание принципов разработки серверных приложений:  
- проектирование **REST API**,  
- работа с **базой данных**,  
- организация **бизнес-логики**,  
- обработка **ошибок** и исключений.  
